# P-001: GCal Extractor

**Project**: Google Calendar Consultation Report Generator  
**Appetite**: 1 week ViebCoding  
**Start Date**: 2025-01-09  

## Project Overview

Streamlit-based Python application for psychology professionals to generate Excel reports of patient consultation frequency from Google Calendar events.

## Agreed Specifications

- **No caching**: Direct API calls for fresh data
- **Timestamped files**: Excel files include timestamp (e.g., `report_2024_01_20250109_143022.xlsx`)
- **No limits**: Support unlimited calendars and events
- **Basic formatting**: Simple Excel styling

## Scopes and Tasks

### Scope 1: Authentication & Setup
- [X] Implement Google OAuth 2.0 flow
- [X] Create token management system with automatic refresh
- [X] Build calendar discovery and selection interface
- [X] Implement configuration persistence (config.json, tokens.json)
- [X] Add logout/reconnect functionality

### Scope 2: Data Processing Core
- [X] Implement Google Calendar API integration
- [X] Create event fetching with month/year filtering
- [X] Build patient name normalization (capitalize, trim spaces)
- [X] Implement "Padres de [Name]" logic for patient grouping
- [X] Create data aggregation for report generation

### Scope 3: Report Generation
- [X] Set up Excel file creation with openpyxl
- [X] Implement "totales" sheet (calendario | nombre | total)
- [X] Implement "detalle" sheet (patient columns with dates by calendar)
- [X] Add date formatting (dd/mm/yyyy)
- [X] Implement timestamped file naming
- [X] Add basic Excel formatting

### Scope 4: Streamlit UI
- [X] Create authentication flow interface
- [X] Build main dashboard with calendar display
- [X] Implement month/year selection dropdowns
- [X] Add generate report functionality
- [X] Implement download report feature
- [X] Add comprehensive error handling and user feedback
- [X] Create settings section for logout/reconnect

## Technical Architecture

### File Structure
```
├── streamlit_app.py          # Main UI application
├── google_auth.py            # OAuth handling
├── calendar_service.py       # Google Calendar API integration
├── excel_generator.py        # Report generation
├── requirements.txt          # Dependencies
├── config.json              # Calendar selection (generated)
├── tokens.json              # OAuth tokens (generated)
└── reports/                 # Generated Excel files
```

### Dependencies
- `streamlit` - Web UI framework
- `google-auth-oauthlib` - Google OAuth
- `google-api-python-client` - Google Calendar API
- `pandas` - Data processing
- `openpyxl` - Excel file generation

### Key Implementation Details

**Patient Processing**:
- Events titled "Padres de [Name]" count toward [Name]'s total
- "Padres de [Name]" appear as separate entries in detalle sheet
- Name normalization: capitalize and trim spaces
- No fuzzy matching (exact string processing)

**Excel Output**:
- **Sheet 1 "totales"**: calendario | nombre | total
- **Sheet 2 "detalle"**: Patient columns grouped by calendar with consultation dates
- Date format: dd/mm/yyyy
- File naming: `report_YYYY_MM_YYYYMMDD_HHMMSS.xlsx`

**Error Handling**:
- Network connectivity issues
- API rate limits
- Token expiration
- Invalid date ranges
- No events found

## Next Steps

1. Set up development environment and dependencies
2. Start with Scope 1: Authentication & Setup
3. Implement Google OAuth flow and token management
4. Build calendar selection interface

## Success Criteria

- [ ] Successfully generates accurate Excel reports from Google Calendar data
- [ ] User can complete full workflow (connect → configure → generate → download) in under 3 minutes
- [ ] Handles authentication refresh and basic error scenarios gracefully
- [ ] Report data matches actual calendar events with 100% precision

## Circuit Breaker

If Google Calendar API integration proves more complex than anticipated, stop development and reassess approach.
